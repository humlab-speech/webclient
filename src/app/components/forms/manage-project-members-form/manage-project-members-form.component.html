<div [formGroup]="form">
    <!--
    <div *ngIf="loadingStatus" class="session-loading-indicator-container">
        <img src="../../../assets/loading-indicator-4-dark.svg">
        Loading project data: {{ loadingMessage }}
    </div>
    -->

    <div *ngIf="userIsProjectMaintainer()" class="form-control-pair-container">
        <div (click)="toggleMemberSearch()" class="form-control-pair-label">
            <i class="fa fa-plus-circle" aria-hidden="true"></i>
            &nbsp;
            Add member
        </div>
        <div id="search-user-input" class="form-control-pair-input">
            <label>Search user:&nbsp;</label>
            <div>
                <input type="text" id="search-user-control" (keyup)="searchUser($event)"/>
                <div id="user-select-options">
                    <ul class="select-search-results-list" *ngFor="let searchUser of searchUsers">
                        <li (click)="addMember(searchUser)" class="search-option-user-container">
                            <img src="{{searchUser.avatar_url}}" class="avatar_image" />
                            {{searchUser.name}}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <br />
    </div>


    <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
        
        <!-- This is the bundle-nodes -->
        <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle matTreeNodePadding>
          <mat-checkbox class="checklist-leaf-node very-special-checkbox" style="margin-left:2em;"
                        [checked]="checklistSelection.isSelected(node)"
                        (change)="todoLeafItemSelectionToggle(node)">
                        {{node.item}}
                        <i *ngIf="finishedEditing(node)" class="fa fa-check-circle-o" aria-hidden="true"></i>
                        &nbsp;
                        <i *ngIf="getNumberOfBundleAssignees(node) > 1" matTooltip="This bundle has multiple people assigned." class="fa fa-users" aria-hidden="true"></i>
            </mat-checkbox>
        </mat-tree-node>
      
        <!-- This is everything but the bundle-nodes (user and session nodes) -->
        <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
          <button mat-icon-button matTreeNodeToggle
                  [attr.aria-label]="'Toggle ' + node.item">
            <mat-icon class="mat-icon-rtl-mirror">
              {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
            </mat-icon>
          </button>

          <!-- Don't render checkboxes for the user-level -->
          <div *ngIf="node.level>0">
            <mat-checkbox class="very-special-checkbox" [checked]="descendantsAllSelected(node)"
                        [indeterminate]="descendantsPartiallySelected(node)"
                        (change)="todoItemSelectionToggle(node)">
                        {{node.item}}
                        <!--<i *ngIf="getNumberOfBundleAssigneesInSession(node) > 1" matTooltip="This session has bundles with multiple people assigned." class="fa fa-users" aria-hidden="true"></i>-->
                    </mat-checkbox>  
          </div>

          <div *ngIf="node.level==0">
            {{node.item}} <button *ngIf="userIsProjectOwner(node) == false" class="delete-button-small" (click)="removeMember(node)"><i class="fa fa-minus-square" aria-hidden="true"></i></button>
          </div>
          
        </mat-tree-node>
    </mat-tree>


    <!--
    <ul *ngFor="let member of projectMemberForms.controls">


        <summary>
            <img src="{{member.controls.member.value.avatar_url}}" class="avatar_image" /> {{member.controls.member.value.name}}
            <span *ngIf="member.controls.member.value.id == project.owner.id"> | project owner</span>

            <mat-tree [dataSource]="dataSource" [treeControl]="treeControl">
                <mat-tree-node *matTreeNodeDef="let node" matTreeNodeToggle matTreeNodePadding>
                  <mat-checkbox class="checklist-leaf-node very-special-checkbox" style="margin-left:2em;"
                                [checked]="checklistSelection.isSelected(node)"
                                (change)="todoLeafItemSelectionToggle(node)">{{node.item}}</mat-checkbox>
                </mat-tree-node>
              
                <mat-tree-node *matTreeNodeDef="let node; when: hasChild" matTreeNodePadding>
                  <button mat-icon-button matTreeNodeToggle
                          [attr.aria-label]="'Toggle ' + node.item">
                    <mat-icon class="mat-icon-rtl-mirror">
                      {{treeControl.isExpanded(node) ? 'expand_more' : 'chevron_right'}}
                    </mat-icon>
                  </button>
                  <mat-checkbox class="very-special-checkbox" [checked]="descendantsAllSelected(node)"
                                [indeterminate]="descendantsPartiallySelected(node)"
                                (change)="todoItemSelectionToggle(node)">{{node.item}}</mat-checkbox>
                </mat-tree-node>
            </mat-tree>
        </summary>
       
    </ul>
    -->
    

    <!--
    <ul *ngFor="let member of projectMemberForms.controls">
        <li>
            <details>
                <summary>
                    <img src="{{member.controls.member.value.avatar_url}}" class="avatar_image" /> {{member.controls.member.value.name}}
                    <span *ngIf="member.controls.member.value.id == project.owner.id"> | project owner</span>
                </summary>
                
                <div>
                    
                    <div class="bundle-container">
                        <h5>Assigned bundles</h5>
                        <ul *ngFor="let session of member.controls.sessions.controls">

                            <li>
                                <mat-checkbox class="checklist-leaf-node very-special-checkbox"
                                [checked]="false"
                                [indeterminate]="true"
                                (change)="sessionClicked(session, $event)"
                                >{{session.value.sessionName}}</mat-checkbox>

                                <ul *ngFor="let bundle of session.value.bundles">
                                    <li class="bundle-li">
                                        <input id="{{member.controls.member.value.username}}-{{session.value.sessionName}}-{{bundle.bundleName}}" [checked]="memberHasBundle(member.value.member.username, session.value.sessionName, bundle.bundleName)" (click)="bundleClicked(member.value.member.username, session.value.sessionName, bundle.bundleName, $event)" type="checkbox" />
                                        <label for="{{member.controls.member.value.username}}-{{session.value.sessionName}}-{{bundle.bundleName}}">{{bundle.bundleName}}</label>
                                    </li>
                                </ul>

                            </li>
                            
                            
                        </ul>
                    </div>

                    <div *ngIf="member.controls.member.value.id != project.owner.id && userIsProjectMaintainer()" class="remove-button-container">
                        <div (click)="removeMember(member.controls.member.value)" class="list-button remove-member-button">
                            <div>
                                <i class="fa fa-times" aria-hidden="true"></i> Remove member
                            </div>
                        </div>
                    </div>
                    
                </div>
            </details>
            
        </li>
    </ul>
    -->

    
    <br />
    <button id="member-form-save-button" [ngClass]="{'disabled': !submitBtnEnabled}" [disabled]="!submitBtnEnabled" (click)="saveForm()">
        <img *ngIf="showLoadingIndicator" src="../../../../assets/loading-indicator-4-light.svg">
        <i *ngIf="!showLoadingIndicator" class="fa fa-save" aria-hidden="true"></i>
        &nbsp;
        {{ submitBtnLabel }}
    </button>

</div>